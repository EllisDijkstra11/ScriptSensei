<!DOCTYPE html>
<html lang="en">

<head>
    <title>Writing</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script defer src="https://pyscript.net/alpha/pyscript.js"></script>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <input type="hidden" id="bestFits"/>
    <div class="main">
        <div class="header">
            <div class="block flexbox">
                Number of kanji answered:
                <div>
                    <p style="line-height: var(--larger); font-size: var(--larger);"><span id="numberOfKanji"></span>/<span id="totalNumberOfKanji"></span>
                    </p>
                </div>
                <button id="quit">Quit</button>
            </div>
            <div class="flexbox" style="height:30%;">
                Write the kanji for
            </div>
            <div class="flexbox" style="height:60%">
                <h2><span id="meaning_display"></span><br>
                </h2>
            </div>
        </div>

        <div class="content">
            <svg id="canvas" class="flexbox"></svg>
        </div>

        <div style="display: flex; flex-direction: row; gap: 10px; width: 100%;">
            <button id="clear" style="background-color: var(--light-blue);">Clear canvas</button>
            <button id="check_kanji">Check kanji</button>
        </div>

        <div id="kanjiCharacter" data-kanji="{{ kanji_character }}"></div>
        <div id="svgResult"></div>

        <div class="popup" id="resultPopup">
            <div class="flexbox header" style="height: 175px; justify-content: center;">
                <h1>
                    Feedback
                </h1>
            </div>
            <div id="countInfo"  class="flexbox" style="text-align: left;">
                <div>
                    Number of strokes:
                </div>
                <div style = "width: 60%;">
                    <button id="countButton"></button>
                </div>
            </div>
            <div id="sizeInfo"  class="flexbox" style="text-align: left;">
                <div>
                    Size difference:
                </div>
                <div style = "width: 60%;">
                    <button id="sizeButton"></button>
                </div>
            </div>
            <table id="resultTable">
                <thead>
                    <tr>
                        <th> </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Direction</td>
                    </tr>
                    <tr>
                        <td>Order</td>
                    </tr>
                    <tr>
                        <td>Shape</td>
                    </tr>
                </tbody>
            </table>
            <div class="flexbox" style="text-align: left;">
                <div style = "width: 47.5%;">
                    <button id="sizeButton" style="background-color: var(--light-blue);">Repractise kanji</button>
                </div>
                <div style = "width: 47.5%;">
                    <button id="sizeButton">Next kanji</button>
                </div>
            </div>
        </div>
    
    </div>

    <!-- <script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.0/TweenMax.min.js"></script> -->
    <!-- <script src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/16327/MorphSVGPlugin.min.js?v=3"></script> -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js"></script> -->
    <script src="../static/strokeInput.js" type="module"></script>
    <script type="module">
        import bestFits from "../static/strokeInput.js"
        let selectedKanji;
        let totalNumberOfKanji;
        let currentRandomIndex = -1;
        let currentKanji;

        document.addEventListener('DOMContentLoaded', () => {
            selectedKanji = JSON.parse('{{ selectedKanji|tojson|safe }}');
            totalNumberOfKanji = selectedKanji.length
            showRandomKanji();
        });

        document.getElementById('quit').addEventListener('click', () => {
            window.location.href = `/select`;
        });

        document.getElementById('check_kanji').addEventListener('click', () => {
            check_kanji(currentKanji);
        });

        function showRandomKanji() {
            if (selectedKanji.length === 0) {
                window.location.href = '/select';
            }

            const kanji = document.getElementById('kanjiCharacter').dataset.kanji;
            document.getElementById('numberOfKanji').innerHTML = totalNumberOfKanji - selectedKanji.length;
            document.getElementById('totalNumberOfKanji').innerHTML = totalNumberOfKanji;

            currentRandomIndex = Math.floor(Math.random() * selectedKanji.length);
            const randomKanji = selectedKanji[currentRandomIndex];
            const meaning = randomKanji[1]

            document.getElementById('meaning_display').innerText = `${meaning}`;
            selectedKanji.splice(currentRandomIndex, 1);

            console.log(randomKanji[0]);
            currentKanji = randomKanji[0];
        }

        function check_kanji(kanji) {
            fetch('/check_kanji', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ kanji: kanji, array: bestFits })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('svgResult').innerText = data.error;
                } else {
                    document.getElementById('svgResult').innerHTML = data.svg;
                    showPopup(data.score);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function showPopup(score) {
            var count = score[0];
            var size = score[1];
            var directions = score[2];
            var orders = score[3];
            var shapes = score[4];
            var tableHead = document.getElementById('resultTable').querySelector('thead tr');
            var tableBody = document.getElementById('resultTable').querySelector('tbody');
            var resultInfo = document.getElementById('resultInfo');

            // Clear previous results
            tableHead.innerHTML = '<th> </th>';
    tableBody.innerHTML = '';

    // Determine the number of strokes based on directions (or any other array, as they should all have the same length)
    var numStrokes = directions.length;

    // Populate the header row with stroke numbers
    for (var i = 0; i < numStrokes; i++) {
        var headerCell = document.createElement('th');
        var headerButton = document.createElement('button');
        headerButton.innerText = i + 1;
        headerButton.style.backgroundColor = 'var(--light-blue)'; // Set background color
        headerCell.appendChild(headerButton);
        tableHead.appendChild(headerCell);
    }

    // Create rows for directions, orders, and shapes
    var directionRow = document.createElement('tr');
    var orderRow = document.createElement('tr');
    var shapeRow = document.createElement('tr');

    // Add row headers
    var directionHeader = document.createElement('td');
    var directionHeaderButton = document.createElement('button');
    directionHeaderButton.innerText = 'Direction';
    directionHeaderButton.style.backgroundColor = 'var(--light-blue)'; // Set background color
    directionHeader.appendChild(directionHeaderButton);
    directionRow.appendChild(directionHeader);

    var orderHeader = document.createElement('td');
    var orderHeaderButton = document.createElement('button');
    orderHeaderButton.innerText = 'Order';
    orderHeaderButton.style.backgroundColor = 'var(--light-blue)'; // Set background color
    orderHeader.appendChild(orderHeaderButton);
    orderRow.appendChild(orderHeader);

    var shapeHeader = document.createElement('td');
    var shapeHeaderButton = document.createElement('button');
    shapeHeaderButton.innerText = 'Shape';
    shapeHeaderButton.style.backgroundColor = 'var(--light-blue)'; // Set background color
    shapeHeader.appendChild(shapeHeaderButton);
    shapeRow.appendChild(shapeHeader);

    // Populate the rows with data
    for (var i = 0; i < numStrokes; i++) {
        var directionCell = document.createElement('td');
        var directionButton = document.createElement('button');
        directionButton.innerText = directions[i];
        directionCell.appendChild(directionButton);
        directionRow.appendChild(directionCell);

        var orderCell = document.createElement('td');
        var orderButton = document.createElement('button');
        orderButton.innerText = orders[i] || 'not found';
        orderCell.appendChild(orderButton);
        orderRow.appendChild(orderCell);

        var shapeCell = document.createElement('td');
        var shapeButton = document.createElement('button');
        shapeButton.innerText = shapes[i];
        shapeCell.appendChild(shapeButton);
        shapeRow.appendChild(shapeCell);
    }

    tableBody.appendChild(orderRow);
    tableBody.appendChild(directionRow);
    tableBody.appendChild(shapeRow);

            // Display the count and size in the popup info
            document.getElementById('countButton').innerHTML = `${count}`;
            document.getElementById('sizeButton').innerHTML = `${size}/10`;

            // Display the popup
            document.getElementById('resultPopup').style.display = 'block';
        }

        function closePopup() {
            document.getElementById('resultPopup').style.display = 'none';
        }

    </script>
</body>

</html>
